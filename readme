# https://computingforgeeks.com/install-postgresql-11-on-ubuntu-18-04-ubuntu-16-04/

wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" >> /etc/apt/sources.list.d/pgdg.list'

sudo apt-get update

sudo apt-get -y install postgresql-11

postgres.conf
listen_addresses = '*'
port = 5432

timezone = 'Europe/Moscow'

data_directory = '/var/lib/postgresql/11/main'
hba_file = '/etc/postgresql/11/main/pg_hba.conf'
ident_file = '/etc/postgresql/11/main/pg_ident.conf'
external_pid_file = '/var/run/postgresql/11-main.pid'
unix_socket_directories = '/var/run/postgresql'

password_encryption = md5

max_connections = 200
shared_buffers = 512MB
effective_cache_size = 1536MB
maintenance_work_mem = 128MB
checkpoint_completion_target = 0.7
work_mem = 2621kB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200

# master
wal_level = replica
max_wal_senders = 10
wal_keep_segments = 32
wal_buffers = 16MB

# slave
hot_standby = on
hot_standby_feedback=on

min_wal_size = 1GB
max_wal_size = 2GB

log_destination = 'stderr'
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0640
log_rotation_age = 1d
log_rotation_size = 50MB

log_timezone = 'Europe/Moscow'

log_min_messages = info
log_min_error_statement = error
log_min_duration_statement = 1000

log_line_prefix = '%m [%p] %q%u@%d '    
# special values:
#   %a = application name
#   %u = user name
#   %d = database name
#   %r = remote host and port
#   %h = remote host
#   %p = process ID
#   %t = timestamp without milliseconds
#   %m = timestamp with milliseconds
#   %n = timestamp with milliseconds (as a Unix epoch)
#   %i = command tag
#   %e = SQL state
#   %c = session ID
#   %l = session line number
#   %s = session start timestamp
#   %v = virtual transaction ID
#   %x = transaction ID (0 if none)
#   %q = stop here in non-session
#        processes
#   %% = '%'
# e.g. '<%u%%%d> '

debug_pretty_print = on

# slave
rm /var/lib/postgresql/11/main/
pg_basebackup -P -R -X stream -c fast -h 192.168.50.4  -U replica -D /var/lib/postgresql/11/main/
cat /var/lib/postgresql/11/main/recovery.conf 
standby_mode = 'on'
primary_conninfo = 'user=replica password=test host=192.168.50.4 port=5432 sslmode=prefer sslcompression=0 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
trigger_file = replication.finish

# pgpool
logging
/etc/systemd/system/pgpool2.service root/root

ExecStart=/bin/sh -c '/usr/sbin/pgpool -n -d 2>&1 | cronolog --hardlink=/var/log/pgsql/pgpool.log "/var/log/postgresql/pgpool-%%Y-%%m-%%d.log" &'
ExecStop=/usr/sbin/pgpool -m fast stop